---
title: "Results"
author: "Stephanie Bland"
date: '2017-10-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE,echo=FALSE)
```
```{r hidden}
#---- Hidden ----
library(ggbiplot)
library(tidyverse)
library(MASS)
library(stringr)
DATE="2017Jul19"
Version="0"
location="/GIT/Analysis"#For Running on my Mac
#location=""#For Clusters
run_name=paste0(DATE,"_",Version)
setwd(paste0("~/",location,"/",run_name))
#---- LOAD_DATA ----
backupdata=read.table("Melted.txt",header=F)
colnames(backupdata)=as.matrix(read.table("colnames.txt"))
alldata=backupdata
alldata=alldata[alldata$Prey==0,]
alldata=alldata[alldata$Pred==2,]
alldata=alldata[alldata$Phase_df==2,]

#---- LOAD_DATA ----
# The first step should be setting up better names, so the legends will automatically be named properly. This is to avoid having vague graphs with names like "experiment 1" and experiment 2" because people will definitely forget what that means.
node_names=levels(factor(alldata$Nodes_df))
# In the following line we have some difficulty with node names - after 10 the levels function tries to sort alphabetically but fails miserably.
node_names=cbind(node_names,c("Autotrophs",paste("Life stage",1:4),paste("Fish",1:3),"Fish","Invertebrates",rep("Node",39),"Non Fish","Total Biomass"))
exper_name=c("Leslie & History","Extended Web","Original Web")

##### Load New data format too
dat=read.table("clean.txt",header=F)
colnames(dat)=as.matrix(read.table("colnames_clean.txt"))
```
```{r DefineMultiplot}
# From https://stackoverflow.com/a/24387436
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

## First Paragraph: Overall description, general overview

```{r Percent_Stable}
nodes="Fish_tot_df"
persist=alldata %>% group_by(Simnum, Exper, Nodes_df) %>%
	filter(Year_df %in% max(Year_df), Nodes_df %in% nodes) %>%
	spread(key=Exper, value=Biomass) %>%
	summarise(any=sum(`1`,`2`,`3`),all=prod(`1`,`2`,`3`)) %>%
	mutate_at(c("any","all"),as.logical)
# 1.
criteria1=100*sum(persist$any)/length(persist$any)
# 2.
criteria2=100*sum(persist$all)/length(persist$all)
```

A typical time series of the logged biomass for a stable population is shown in figure x. 

`r criteria1`% of our simulations met the criteria for the first part of the analysis, meaning fish stabilized in at least one of the experiments. `r criteria2`% of our simulations met the second criteria, where at least one fish must stabilize in every experiment. We anticipated that some simulations would never stablize, as we placed minimal constraints on food webs during the web creation stage. Some of the webs we created would invariably end up being completely biologically unrealistic. This process of weeding out unstable webs might seem unintuitive at first, but it mimics what we observe in nature. Just as natural landscapes are eventually populated by stable ecosystems after a long process of species invasions and extinctions. One would not expect to be able to take a random species from a different continent and populate an island and fill a niche that they were not adapted to. The few species that can successfully invade are anomalies. 
```{r Total Biomass Stability}
nodes="Tot_df"
persist=alldata %>% group_by(Simnum, Exper, Nodes_df) %>%
	filter(Year_df %in% max(Year_df), Nodes_df %in% nodes) %>%
	spread(key=Exper, value=Biomass) %>%
	summarise(any=sum(`1`,`2`,`3`),all=prod(`1`,`2`,`3`)) %>%
	mutate_at(c("any","all"),as.logical)
# Percent of webs that stabilize for any species in every experiment
criteria2_totBiomass=100*sum(persist$all)/length(persist$all)
```
`r criteria2_totBiomass`% of our simulations stabilized for any species in every experiment. This includes webs were fish would go extinct. 

## Second Paragraph: Number of extinctions
```{r extant_nodes}
node_ls=unique(alldata$Nodes_df)[str_detect(unique(alldata$Nodes_df),"Node_")]
count_extant=alldata %>% group_by(Simnum, Exper, Nodes_df) %>%
	filter(Year_df %in% max(Year_df), Nodes_df %in% node_ls) %>% 
	summarise(Extant=(Biomass>0)) %>%
	spread(key=Nodes_df, value=Extant) %>%
	summarise(node_persist=sum(Node_1,Node_2,Node_3,Node_4,Node_5,Node_6,Node_7,Node_8,Node_9,Node_10,Node_11,Node_12,Node_13,Node_14,Node_15,Node_16,Node_17,Node_18,Node_19,Node_20,Node_21,Node_22,Node_23,Node_24,Node_25,Node_26,Node_27,Node_28,Node_29,Node_30,Node_31,Node_32,Node_33,Node_34,Node_35,Node_36,Node_37,Node_38,Node_39)) %>%
	spread(key=Exper,value=node_persist)
x=mean(count_extant$`1`)/39
y=mean(count_extant$`2`)/39
z=mean(count_extant$`3`)/30
sem <- function(x) {sd(x)/sqrt(length(x))}
meh=data.frame(Exper=1:3,Num_extant=c(x,y,z),se=c(sem(count_extant$`1`/39),sem(count_extant$`2`/39),sem(count_extant$`3`/30)))
ggplot(meh, aes(x=Exper, y=Num_extant)) +
	geom_bar(position=position_dodge(),stat="identity") + 
	geom_errorbar(aes(ymin=Num_extant-2*se, ymax=Num_extant+2*se), width=.1) +
	xlab("Experiment") + ylab("Percent of extant nodes") +
	labs(caption="Figure 1 The mean percent of extant nodes in each experiment. The error bars are of 2 times the standard error.")
```

The mean percent of extant nodes is shown in figure 1. This indicates that the new fish life stages we added are probably more likely to go extinct than an average node. (Although it could also be true that the new lifestages aren't more likely to go extinct, but the presence of them destabilizes other species instead so other species are more likely to go extinct when new nodes are added.)

```{r extant_fish}
count_extant=alldata %>% group_by(Simnum, Exper, Nodes_df) %>%
	filter(Year_df %in% max(Year_df), str_detect(Nodes_df,"Fish_sp_")) %>% 
	summarise(Extant=(Biomass>0)) %>%
	spread(key=Nodes_df, value=Extant) %>%
	summarise(fish_persist=sum(Fish_sp_1,Fish_sp_2,Fish_sp_3)) %>%
	spread(key=Exper,value=fish_persist) %>%
	mutate(keep_sim=sum(`1`,`2`,`3`)) %>%
	filter(keep_sim>0)
x=mean(count_extant$`1`)
y=mean(count_extant$`2`)
z=mean(count_extant$`3`)
sem <- function(x) {sd(x)/sqrt(length(x))}
meh=data.frame(Exper=1:3,Num_extant=c(x,y,z),se=c(sem(count_extant$`1`),sem(count_extant$`2`),sem(count_extant$`3`)))
ggplot(meh, aes(x=Exper, y=Num_extant)) +
	geom_bar(position=position_dodge(),stat="identity") + 
	geom_errorbar(aes(ymin=Num_extant-2*se, ymax=Num_extant+2*se), width=.1) +
	xlab("Experiment") + ylab("Number of extant fish") +
	labs(caption="Figure 2 The mean number of extant fish in each experiment. The error bars are of 2 times the standard error.")
```

The mean number of extant species is shown in figure 2. Since we only require one life stage to persist for the duration of the simulation, fish will have a lower extinction rate in the experiments with additional nodes.

## Third Paragraph: Stability -> Coefficient variation (CV)
```{r CV_total}
# Coefficient of Variation Function
CV <- function(dat){sd(dat)/mean(dat)*100}

nodes="Tot_df"
CV_calc <- alldata %>% group_by(Exper, Simnum, Nodes_df) %>% 
	filter(Phase_df==2) %>%
	summarise(CV = CV(Biomass)) %>% 
	filter(Nodes_df %in% nodes) %>%
	spread(key=Exper, value=CV)
x=mean(CV_calc$`1`,na.rm=T)
y=mean(CV_calc$`2`,na.rm=T)
z=mean(CV_calc$`3`,na.rm=T)
sem <- function(x) {sd(x,na.rm=T)/sqrt(sum(is.na(x)))}
meh=data.frame(Exper=1:3,mean_cv=c(x,y,z),se=c(sem(CV_calc$`1`),sem(CV_calc$`2`),sem(CV_calc$`3`)))
ggplot(meh, aes(x=Exper, y=mean_cv)) +
	geom_bar(position=position_dodge(),stat="identity") + 
	geom_errorbar(aes(ymin=mean_cv-2*se, ymax=mean_cv+2*se), width=.1) +
	xlab("Experiment") + ylab("Mean Coefficient of Variation") +
	labs(caption="Figure 3 The mean CV of the total biomass. The error bars are of 2 times the standard error.")

```
Standard error is too high - I don't want to include figure 3. 

```{r CV_fish}
# Coefficient of Variation Function
CV <- function(dat){sd(dat)/mean(dat)*100}

nodes="Fish_tot_df"
CV_calc <- alldata %>% group_by(Exper, Simnum, Nodes_df) %>% 
	summarise(CV = CV(Biomass)) %>% 
	filter(Nodes_df %in% nodes) %>%
	spread(key=Exper, value=CV)
x=mean(CV_calc$`1`,na.rm=T)
y=mean(CV_calc$`2`,na.rm=T)
z=mean(CV_calc$`3`,na.rm=T)
sem <- function(x) {sd(x,na.rm=T)/sqrt(sum(is.na(x)))}
meh=data.frame(Exper=1:3,mean_cv=c(x,y,z),se=c(sem(CV_calc$`1`),sem(CV_calc$`2`),sem(CV_calc$`3`)))
ggplot(meh, aes(x=Exper, y=mean_cv)) +
	geom_bar(position=position_dodge(),stat="identity") + 
	geom_errorbar(aes(ymin=mean_cv-2*se, ymax=mean_cv+2*se), width=.1) +
	xlab("Experiment") + ylab("Mean Coefficient of Variation") +
	labs(caption="Figure 4 The mean CV of total fish biomass. The error bars are of 2 times the standard error.")

```
Figure 4 Shows the mean CV for the total fish biomass. The linked life stages experiment has a higher mean CV and a higher standard error. There is more variance because one life stage can re-establish the populations of other life stages that are less suited to the environment. 

[Note: if there are any fish species with exponential growth, it would really throw the CV off for experiment 1. All these results are tentative, I have a low sample size, and I want to test it with the simplified Leslie Matrix.]

```{r fish_else_ratio}
ratio=alldata %>% group_by(Simnum, Exper, Nodes_df) %>%
	filter(Year_df %in% max(Year_df),Nodes_df %in% c("Fish_tot_df", "Tot_df")) %>%
	spread(key=Nodes_df,value=Biomass) %>%
	mutate(Fish_ratio=Fish_tot_df/Tot_df) %>%
	group_by(Exper) %>%
	summarise(mean(Fish_ratio,na.rm=T))
ratio
```

The fish to total biomass ratios for each experiment is shown in table 1. 


## End paragraph: Von-Bertalanffy
```{r Von-Bert-solo}
dat %>% filter(Simnum==3,Exper==1,Year_df==1,isfish==1,Biomass>0) %>%
	mutate(species=factor(species),lifestage=as.integer(lifestage)) %>%
	ggplot(aes(x=lifestage, y=Mass, colour=species))+geom_line()
```

```{r Von-Bert-Multi}
dat %>% filter(Simnum<10,Exper==1,Year_df==1,isfish==1,Biomass>0) %>%
	mutate(species=factor(as.integer(species)+(39*Simnum)),lifestage=as.integer(lifestage)) %>%
	ggplot(aes(x=lifestage, y=log10(Mass), colour=species))+geom_line()
```

```{r Von-Bert-grid-plot}
VB_grid=dat %>% filter(Simnum<10,Exper==1,Year_df==1,isfish==1,Biomass>0) %>%
	mutate(species=factor(species),lifestage=as.integer(lifestage)) %>%
	group_by(Simnum) %>%
	do(g=ggplot(.,aes(x=lifestage, y=Mass, colour=species))+geom_line())
multiplot(VB_grid$g[[1]], VB_grid$g[[2]], VB_grid$g[[3]], VB_grid$g[[4]], VB_grid$g[[5]], VB_grid$g[[6]], VB_grid$g[[7]], VB_grid$g[[8]], VB_grid$g[[9]], cols=3)
```
PROVE THAT FISH LIFE HISTORIES LOOK REALISTIC. I WANT TO CONVINCE THE READER THAT THESE ARE REAL FISH TOTALLY NOT MADE UP
coefficient of variation plot (indep) against weight_\infty (dependent) also biomass against weight_\infty (for both fish and total so four panel plot!)



```{r pressure, echo=FALSE}
#plot(pressure)
```















