---
title: "Results"
author: "Stephanie Bland"
date: '2017-10-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=TRUE,echo=FALSE)
```
```{r hidden}
#---- Hidden ----
library(ggbiplot)
library(tidyverse)
library(stringr)
DATE="2017Oct30"
Version="0"
location="/GIT/Analysis"#For Running on my Mac
#location=""#For Clusters
run_name=paste0(DATE,"_",Version)
setwd(paste0("~/",location,"/",run_name))
#---- LOAD_DATA ----
dat=read.table("clean.txt",header=F)
colnames(dat)=as.matrix(read.table("colnames_clean.txt"))
# The first step should be setting up better names, so the legends will automatically be named properly. This is to avoid having vague graphs with names like "experiment 1" and experiment 2" because people will definitely forget what that means.
exper_name=c("Leslie & History","Extended Web","Original Web")
# Make Processing faster, I think? - DONT USE THIS YET - IT WILL BREAK THINGS!
# dat=dat %>% mutate_at(c("isfish","basal_ls"),as.logical) %>%
#	mutate_at(c("Phase_df","Nodes_df","Seed","Exper","pred","prey","species","lifestage"),as.factor)
```
```{r DefineMultiplot}
# From https://stackoverflow.com/a/24387436
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  require(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

## First Paragraph: Overall description, general overview

```{r Percent_Stable}
# Subset the data that fit criteria 1 and 2
subdat_ls=dat %>% filter(Year_df==max(Year_df),isfish==1) %>% 
	group_by(simnum,Exper) %>%
	summarise(Tot_species=sum(Biomass)) %>% # But now it needs to survive in ALL experiments
	summarise(any=sum(Tot_species),all=prod(Tot_species)) %>%
	mutate_at(c("any","all"),as.logical)
persist=subdat_ls %>% summarise_at(c("any","all"),mean)*100
# Criteria 1: Probability of fish persisting in at least one of the experiments
# Criteria 2: Probability of fish persisting in all of the experiments
subdat1=dat %>% filter(simnum %in% (subdat_ls %>% filter(any==TRUE))$simnum)
subdat2=dat %>% filter(simnum %in% (subdat_ls %>% filter(all==TRUE))$simnum)
```

A typical time series of the logged biomass for a stable population is shown in figure x. 

`r persist$any`% of our simulations met the criteria for the first part of the analysis, meaning fish stabilized in at least one of the experiments. `r persist$all`% of our simulations met the second criteria, where at least one fish must stabilize in every experiment. We anticipated that some simulations would never stablize, as we placed minimal constraints on food webs during the web creation stage. Some of the webs we created would invariably end up being completely biologically unrealistic. This process of weeding out unstable webs might seem unintuitive at first, but it mimics what we observe in nature. Just as natural landscapes are eventually populated by stable ecosystems after a long process of species invasions and extinctions. One would not expect to be able to take a random species from a different continent and populate an island and fill a niche that they were not adapted to. The few species that can successfully invade are anomalies. 
```{r Total Biomass Stability}
# Percent of webs that stabilize for any species in every experiment
min_viable_webs=dat %>% filter(Year_df==max(Year_df)) %>% 
	group_by(simnum,Exper) %>%
	summarise(Tot_species=sum(Biomass)) %>% # But now it needs to survive in ALL experiments
	summarise(any=sum(Tot_species),all=prod(Tot_species)) %>%
	mutate_at(c("any","all"),as.logical) %>% 
	summarise_at("all",mean)*100
```
`r min_viable_webs`% of our simulations stabilized for any species in every experiment. This includes webs were fish would go extinct. 

## Second Paragraph: Number of extinctions
```{r extant_nodes}
extant_nodes=dat %>% filter(Year_df==max(Year_df)) %>%
	group_by(Exper,simnum,Nodes_df) %>% 
	summarise(extant=as.logical(Biomass)) %>%
	summarise(Num_extant=sum(extant)) %>% 
	mutate(Per_extant=Num_extant/c(39,39,30)[Exper])
boxplot(Per_extant~Exper,extant_nodes,xlab="Experiment",ylab="Percent of extant nodes")
tbl_nodes=extant_nodes %>% summarise(mean(Per_extant),var(Per_extant))
#caption="Figure 1 The mean percent of extant nodes in each experiment. The error bars are of 2 times the standard error."
```

The mean percent of extant nodes is shown in figure 1. This indicates that the new fish life stages we added are probably more likely to go extinct than an average node. (Although it could also be true that the new lifestages aren't more likely to go extinct, but the presence of them destabilizes other species instead so other species are more likely to go extinct when new nodes are added.)

```{r extant_species}
extant_species=dat %>% filter(Year_df==max(Year_df)) %>%
	group_by(Exper,simnum,species) %>% 
	summarise(extant=as.logical(sum(Biomass))) %>%
	summarise(Num_extant=sum(extant)) #%>%
boxplot(Num_extant~Exper,extant_species)
tbl_species=extant_species %>% summarise(mean(Num_extant),var(Num_extant))
```

```{r extant_fish}
extant_fish=dat %>% filter(Year_df==max(Year_df),isfish==1) %>%
	group_by(Exper,simnum,species) %>% 
	summarise(extant=as.logical(sum(Biomass))) %>%
	summarise(Num_extant=sum(extant)) #%>%
boxplot(Num_extant~Exper,extant_fish,xlab="Experiment",ylab="Number of extant fish")
tbl_fish=extant_fish %>% summarise(mean(Num_extant),var(Num_extant))
#caption="Figure 2 The mean number of extant fish in each experiment. The error bars are of 2 times the standard error."
```

The mean number of extant species is shown in figure . Since we only require one life stage to persist for the duration of the simulation, fish will have a lower extinction rate in the experiments with additional nodes.

## Third Paragraph: Stability -> Coefficient variation (CV)
```{r CV_total}
# Coefficient of Variation Function
CV <- function(dat){sd(dat)/mean(dat)*100}
sem <- function(x) {sd(x,na.rm=T)/sqrt(sum(is.na(x)))} # Standard error

CV_plot=subdat2 %>% group_by(Exper,simnum,Year_df) %>%
	filter(Phase_df==2) %>%
	summarise(Tot_bio=sum(Biomass),Tot_fish=sum(isfish*Biomass)) %>%
	summarise(CV_tot=CV(Tot_bio),CV_fish=CV(Tot_fish)) # %>% ### So here we see the CVs for fish and total
	#summarise_at(c("CV_tot","CV_fish"),c(mean,sem))

boxplot(CV_tot~Exper,CV_plot,xlab="Experiment",ylab="Coefficient of Variation")

#ggplot(CV_plot,aes(x=Exper,y=CV_tot))+geom_boxplot() + xlab("Experiment") + ylab("Mean Coefficient of Variation") + labs(caption="Figure 3 Box plots for the CV of the total biomass.")

```

```{r CV_fish}
boxplot(CV_fish~Exper,CV_plot,xlab="Experiment",ylab="Coefficient of Variation") 
#	labs(caption="Figure 4 The CV of total fish biomass.")

```
Figure 4 Shows the mean CV for the total fish biomass. The linked life stages experiment has a higher mean CV and a higher standard error. There is more variance because one life stage can re-establish the populations of other life stages that are less suited to the environment. 

[Note: if there are any fish species with exponential growth, it would really throw the CV off for experiment 1. All these results are tentative, I have a low sample size, and I want to test it with the simplified Leslie Matrix.]

```{r fish_else_ratio}
ratio=dat %>% group_by(simnum, Exper,isfish) %>%
	filter(Year_df %in% max(Year_df)) %>% 
	summarise(Tot_group=sum(Biomass)) %>%
	spread(isfish,Tot_group) %>%
	mutate(Fish_ratio=`1`/(`0`+`1`)) %>%
	group_by(Exper) %>%
	summarise(mean(Fish_ratio,na.rm=T))
ratio
```

The fish to total biomass ratios for each experiment is shown in table 1. 


## End paragraph: Von-Bertalanffy
```{r Von-Bert-solo}
dat %>% filter(simnum==3,Exper==1,Year_df==1,isfish==1,Biomass>0) %>%
	mutate(species=factor(species),lifestage=as.integer(lifestage)) %>%
	ggplot(aes(x=lifestage, y=Mass, colour=species))+geom_line()
```

```{r Von-Bert-Multi}
# Caution: The clunky formatting here is because we need to plot ALL life stages if a single life stage survives. This way you won't end up with a partial line between two life stages
subdat1 %>% filter(simnum<10,Exper==1,Year_df==max(Year_df),isfish==1) %>%
	group_by(simnum,species) %>%
	mutate(tot_fish_biom=sum(Biomass)) %>% # Make sure you only grab surviving species, but make sure you grab ALL nodes
	filter(tot_fish_biom>0) %>% # Can't filter by Biomass>0 because some life stages go extinct and you end up with incomplete curves
	ungroup() %>%
	mutate(species=factor(as.integer(species)+(39*simnum)),lifestage=as.integer(lifestage),simnum=as.factor(simnum)) %>% 
	#select(simnum,species,Biomass, tot_fish_biom,Mass)
	ggplot(aes(x=lifestage, y=log10(Mass)))+geom_line(aes(group=species, colour=simnum))
```

the fish for any given web are often of similar size


```{r Von-Bert-grid-plot}
VB_grid=dat %>% filter(simnum<10,Exper==1,Year_df==1,isfish==1,Biomass>0) %>%
	mutate(species=factor(species),lifestage=as.integer(lifestage)) %>%
	group_by(simnum) %>%
	do(g=ggplot(.,aes(x=lifestage, y=Mass, colour=species))+geom_line())
multiplot(VB_grid$g[[1]], VB_grid$g[[2]], VB_grid$g[[3]], VB_grid$g[[4]], VB_grid$g[[5]], VB_grid$g[[6]], VB_grid$g[[7]], VB_grid$g[[8]], VB_grid$g[[9]], cols=3)
```
PROVE THAT FISH LIFE HISTORIES LOOK REALISTIC. I WANT TO CONVINCE THE READER THAT THESE ARE REAL FISH TOTALLY NOT MADE UP
coefficient of variation plot (indep) against weight_\infty (dependent) also biomass against weight_\infty (for both fish and total so four panel plot!)

Produce a histogram of weight_infty!!!! Scale a bunch of sim webs so largest fish is 10^5
```{r Weight_infty-Hist}
subdat1 %>% filter(Exper==1,Year_df==max(Year_df),Biomass>0) %>%
	group_by(simnum) %>%
	mutate(scaled_mass=10^5*Mass/max(Mass)) %>%
	filter(lifestage==4) %>% 
	#select(simnum,Mass,scaled_mass) %>%
	#with(hist(scaled_mass)) #%>%
	with(hist(log10(Mass)))
```

Note to self: So the problem with this histogram plot is that when you scale it you will invariably cause all the fish to be of the same size, so you'll have a massive peak and cliff at 10^5 or whatever you choose to scale by



















